name: New Version

on:
  workflow_dispatch:
    inputs:
      bumpType:
        required: true
        description: Version Bump
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - name: Install cargo-edit
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-edit
      - uses: actions/setup-python@v3

      - name: Determine current version
        id: getOldVersion
        run: echo "::set-output name=version::$(./ci/get_version.py)"

      - name: Bump ${{ github.event.inputs.bumpType }} in Cargo.toml
        uses: actions-rs/cargo@v1
        with:
          command: set-version
          args: --bump ${{ github.event.inputs.bumpType }}
      - name: Update Cargo.lock
        uses: actions-rs/cargo@v1
        with:
          command: update
          args: -p alt

      - name: Determine next version
        id: getNewVersion
        run: echo "::set-output name=version::$(./ci/get_version.py)"

      - name: Update CHANGELOG.md
        env:
          OLD_VERSION: ${{ steps.getOldVersion.outputs.version }}
          NEW_VERSION: ${{ steps.getNewVersion.outputs.version }}
        run: |
          ./ci/add_changelog_version.py \
            --old-version "$OLD_VERSION" \
            --new-version "$NEW_VERSION"

      - run: git diff --color

      - name: Commit & tag ${{ steps.getNewVersion.outputs.version }}
        env:
          NEW_VERSION: ${{ steps.getNewVersion.outputs.version }}
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "<>"
          git add .
          git commit -m "Release $NEW_VERSION"
          git tag "$NEW_VERSION"

      - name: Push ${{ steps.getNewVersion.outputs.version }}
        env:
          NEW_VERSION: ${{ steps.getNewVersion.outputs.version }}
        run: git push --tags origin main
