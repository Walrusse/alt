# Based on the "trust" template v0.1.2
# https://github.com/japaric/trust/tree/v0.1.2

dist: trusty
language: rust
services: docker
sudo: required

matrix:
  fast_finish: true
  allow_failures:
    - rust: beta
    - rust: nightly

  include:
    # Linux
    - env: TARGET=aarch64-unknown-linux-gnu
    - env: TARGET=arm-unknown-linux-gnueabi
    - env: TARGET=armv7-unknown-linux-gnueabihf
    - env: TARGET=i686-unknown-linux-gnu
    - env: TARGET=x86_64-unknown-linux-gnu

    # OSX
    - env: TARGET=i686-apple-darwin
      os: osx
    - env: TARGET=x86_64-apple-darwin
      os: osx

    # TODO: BSD fails to build. Not sure why
    # *BSD
    #- env: TARGET=i686-unknown-freebsd DISABLE_TESTS=1
    #- env: TARGET=x86_64-unknown-freebsd DISABLE_TESTS=1
    #- env: TARGET=x86_64-unknown-netbsd DISABLE_TESTS=1

    # Testing other channels
    - env: TARGET=x86_64-unknown-linux-gnu
      rust: beta
    - env: TARGET=x86_64-apple-darwin
      os: osx
      rust: beta
    - env: TARGET=x86_64-unknown-linux-gnu
      rust: nightly
    - env: TARGET=x86_64-apple-darwin
      os: osx
      rust: nightly

install:
  - source ~/.cargo/env || true
  - cargo install cross || true

script:
  - cross build --target "$TARGET"
  - if [ -z "$DISABLE_TESTS" ]; then cross test --target "$TARGET"; fi
  - if [ -z "$DISABLE_TESTS" ]; then cross run --target "$TARGET" help; fi

before_deploy:
  - cross rustc --bin alt --target "$TARGET" --release -- -C lto
  - gzip "target/$TARGET/release/alt"
  - mv "target/$TARGET/release/alt.gz" "alt_${TRAVIS_TAG}_$TARGET.gz"

deploy:
  api_key:
    secure: "oh1USFlP+HazJn+Pqob32x012P89KKDl/5AegqqUPfFkzBu7sZcWY1ndOhKDpglVIP5Ad3ULPwZXGFAuH3+LFI786dwxUE3Dv+T2LLM32p6s0BP7cENsnkUVaHWGchWRpdyV3sdqJ5shxi6rEqiy2Nghq/CjByFQdEj1QYj4zmN8OcDOlE+OSyJ/uDOlK0oG1sx0UjnBbpIU5NH1cpxwfJOLDbCeZE+RE6tiR2akeQTCF4rTZHTZBHheeyKesBrMSqP6KFPpVCbh7MaU/ZX1tSXQqBTQ671xBP02qlhQWRH1ulbL0TbYjtlqDELLoCZ9ikoUFHK1gfkj0DmEKpZzFq6Bx3KJK5syFjbnGMcf6qbbu1uQS3n1uXspkKIV7+au/LmZaNISORyS2r2gCAiDHE7JJbkXrjbwr7H6YcVA7FLW3LSB0TqPrJurf74qU+HIXtqcMuglXsHsLcGg8CIYsW1lPdeuaviBRT/M5slUsW5gA+KUKyz2VDBMkPARIBOHmPycilfF1Vy/vZ7xTZg6i7ryZzNZCrDEQtGF9xQMmPAjVRQEH1Bv8PmaRYo9a2V1O4xBRS1xks8IODKlnNior/5YPg3k5C25Kj4RQQVhKJKZA5wzU3NQj28IGTlCUbLoBi9s9yJ9jJxX2zFBHanrLdwJwWfMs+UlXDeMWN3L/dA="
  file_glob: true
  file: "alt_${TRAVIS_TAG}_$TARGET.gz"
  on:
    condition: $TRAVIS_RUST_VERSION = stable
    tags: true
  provider: releases
  skip_cleanup: true

cache: cargo
before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo

branches:
  only:
    # release tags
    - /^v\d+\.\d+\.\d+.*$/
    - master

notifications:
  email:
    on_success: never
